// üì° TESTING con tu JSON real
        function testWithRealData() {
            const sampleData = [
                {
                    "pedido_id": "GEO-1754925798980",
                    "status": "completed_con_coordenadas",
                    "rider": {
                        "id": 1,
                        "nombre": "Carlos Delivery",
                        "lat": -34.56077965377718,
                        "lon": -58.461592938922614
                    },
                    "eta_minutos": 3,
                    "ruta_calculada": {
                        "tienda": {
                            "lat": -34.56077965377718,
                            "lon": -58.461592938922614,
                            "nombre": "RutIA Demo",
                            "direccion": "Blanco Encalada 2680, CABA"
                        },
                        "cliente": {
                            "lat": -34.5668707,
                            "lon": -58.4623573,
                            "nombre": "Andres Campolozano",
                            "direccion": "echeverria 3096 caba"
                        },
                        "ruta": {
                            "tiempo_calculado_minutos": 3.3,
                            "coordenadas_array": [
                                [-58.461592938922614,-34.56077965377718],
                                [-58.4626763,-34.5599313],
                                [-58.4618874,-34.5608543],
                                [-58.4646168,-34.5576558],
                                [-58.4639736,-34.5584201],
                                [-58.4633896,-34.559087],
                                [-58.4626763,-34.5599313],
                                [-58.4652688,-34.5568681],
                                [-58.4646168,-34.5576558],
                                [-58.4662144,-34.5573733],
                                [-58.4654403,-34.5569697],
                                [-58.4671892,-34.5578786],
                                [-58.4669021,-34.5577307],
                                [-58.4662144,-34.5573733],
                                [-58.4665062,-34.5586681],
                                [-58.4669826,-34.558119],
                                [-58.4671892,-34.5578786],
                                [-58.4658307,-34.5594475],
                                [-58.4665062,-34.5586681],
                                [-58.4651694,-34.5602219],
                                [-58.4656957,-34.5596033],
                                [-58.4645298,-34.5610114],
                                [-58.4651694,-34.5602219],
                                [-58.463738,-34.5619498],
                                [-58.4641783,-34.5614325],
                                [-58.4644836,-34.5610903],<!DOCTYPE html>
<html>
<head>
    <title>üó∫Ô∏è La Geogr√°fica - Tracking Live</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background: #f0f0f0;
        }
        #map { 
            height: 100vh; 
            width: 100%; 
        }
        .status-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
            border: 3px solid #28a745;
        }
        .logo {
            text-align: center;
            margin-bottom: 15px;
        }
        .logo img {
            max-width: 120px;
            height: auto;
        }
        .status-text {
            font-size: 14px;
            color: #333;
            margin: 8px 0;
        }
        .client-name {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
        }
        .rider-status {
            color: #007bff;
            font-weight: bold;
        }
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .eta {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
        .webhook-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            font-size: 11px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="status-panel" id="statusPanel">
        <div class="logo">
            <img src="assets/logo-geografica.png" alt="La Geogr√°fica" />
        </div>
        
        <div id="clientInfo" class="no-data">
            Esperando pedidos...
        </div>
        
        <div class="webhook-info">
            üì° <strong>Webhook URL (POST):</strong><br>
            <span id="webhookUrl">https://api.allorigins.win/get?url=</span><br>
            <small>n8n debe enviar POST con JSON en body</small>
        </div>
    </div>

    <script>
        // üó∫Ô∏è MAPA limpio centrado en CABA
        const map = L.map('map').setView([-34.6037, -58.3816], 12);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'üõµ La Geogr√°fica - Tracking Live',
            maxZoom: 19
        }).addTo(map);

        // üéØ VARIABLES GLOBALES
        let currentRoute = null;
        let currentMarkers = [];
        let riderMarker = null;
        let animationInterval = null;
        let autoCleanTimer = null;

        // üßπ LIMPIAR MAPA
        function clearMap() {
            if (currentRoute) map.removeLayer(currentRoute);
            currentMarkers.forEach(marker => map.removeLayer(marker));
            if (riderMarker) map.removeLayer(riderMarker);
            if (animationInterval) clearInterval(animationInterval);
            
            currentRoute = null;
            currentMarkers = [];
            riderMarker = null;
            
            document.getElementById('clientInfo').innerHTML = '<div class="no-data">Esperando pedidos...</div>';
        }

        // üîß DEDUPLICAR COORDENADAS
        function dedupeCoords(coords) {
            const seen = new Set();
            return coords.filter(coord => {
                const key = `${coord[0]},${coord[1]}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        // üß≠ NEAREST NEIGHBOR
        function nearestNeighborPath(coords) {
            if (coords.length <= 1) return coords;
            
            const unvisited = new Set(Array.from({length: coords.length}, (_, i) => i));
            const path = [0];
            unvisited.delete(0);
            
            while (unvisited.size > 0) {
                const lastIdx = path[path.length - 1];
                const lastCoord = coords[lastIdx];
                
                let nearestIdx = -1;
                let minDist = Infinity;
                
                for (const idx of unvisited) {
                    const coord = coords[idx];
                    const dist = Math.sqrt(
                        Math.pow(coord[0] - lastCoord[0], 2) + 
                        Math.pow(coord[1] - lastCoord[1], 2)
                    );
                    if (dist < minDist) {
                        minDist = dist;
                        nearestIdx = idx;
                    }
                }
                
                path.push(nearestIdx);
                unvisited.delete(nearestIdx);
            }
            
            return path.map(idx => coords[idx]);
        }

        // üó∫Ô∏è MOSTRAR TRACKING
        function showTracking(data) {
            clearMap();
            
            const trackingData = data[0] || data;
            const ruta = trackingData.ruta_calculada?.ruta;
            const cliente = trackingData.ruta_calculada?.cliente;
            const tienda = trackingData.ruta_calculada?.tienda;
            const rider = trackingData.rider;
            
            if (!ruta || !cliente || !tienda) {
                console.error('Datos incompletos');
                return;
            }

            // üìç PROCESAR COORDENADAS
            let coords = ruta.coordenadas_array || [];
            coords = coords.map(c => [c[1], c[0]]); // lon,lat ‚Üí lat,lon
            coords = dedupeCoords(coords);
            coords = nearestNeighborPath(coords);

            // üó∫Ô∏è RUTA (VERDE como La Geogr√°fica)
            currentRoute = L.polyline(coords, {
                color: '#28a745',
                weight: 4,
                opacity: 0.7
            }).addTo(map);

            // üè™ TIENDA
            const tiendaMarker = L.marker([tienda.lat, tienda.lon], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="30" height="30" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="15" cy="15" r="12" fill="#28a745" stroke="white" stroke-width="3"/>
                            <text x="15" y="20" text-anchor="middle" font-size="14" fill="white">üè™</text>
                        </svg>
                    `),
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).bindPopup(`üè™ ${tienda.nombre}<br>${tienda.direccion}`).addTo(map);

            // üë§ CLIENTE
            const clienteMarker = L.marker([cliente.lat, cliente.lon], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="30" height="30" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="15" cy="15" r="12" fill="#dc3545" stroke="white" stroke-width="3"/>
                            <text x="15" y="20" text-anchor="middle" font-size="14" fill="white">üë§</text>
                        </svg>
                    `),
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).bindPopup(`üë§ ${cliente.nombre}<br>${cliente.direccion}`).addTo(map);

            // üõµ RIDER ANIMADO
            let currentStep = 0;
            riderMarker = L.marker(coords[0], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12.5" cy="12.5" r="10" fill="#007bff" stroke="white" stroke-width="2"/>
                            <text x="12.5" y="17" text-anchor="middle" font-size="12" fill="white">üõµ</text>
                        </svg>
                    `),
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                })
            }).bindPopup(`üõµ ${rider?.nombre || 'Rider'}`).addTo(map);

            currentMarkers = [tiendaMarker, clienteMarker];

            // üé¨ ANIMACI√ìN RIDER
            animationInterval = setInterval(() => {
                currentStep = (currentStep + 1) % coords.length;
                riderMarker.setLatLng(coords[currentStep]);
            }, 2000);

            // üì± ACTUALIZAR PANEL
            const eta = trackingData.eta_minutos || Math.round(ruta.tiempo_calculado_minutos);
            document.getElementById('clientInfo').innerHTML = `
                <div class="client-name">Hola ${cliente.nombre}!</div>
                <div class="status-text">üìç Recibimos tu pedido</div>
                <div class="status-text">üîÑ Estamos preparando tu pedido</div>
                <div class="status-text">üõµ El rider lleg√≥ a la tienda</div>
                <div class="rider-status">${rider?.nombre || 'Carlos'} est√° en camino</div>
                <div class="eta">‚è±Ô∏è Llegada: ${eta} minutos</div>
            `;

            // üéØ ZOOM
            const group = L.featureGroup([tiendaMarker, clienteMarker, currentRoute]);
            map.fitBounds(group.getBounds().pad(0.1));

            // ‚è∞ AUTO-LIMPIAR
            if (autoCleanTimer) clearTimeout(autoCleanTimer);
            autoCleanTimer = setTimeout(() => {
                clearMap();
                map.setView([-34.6037, -58.3816], 12);
            }, 10 * 60 * 1000);
        }

        // üì° WEBHOOK SIMPLE via URL params
        function checkForTrackingData() {
            const urlParams = new URLSearchParams(window.location.search);
            const trackingParam = urlParams.get('tracking');
            
            if (trackingParam) {
                try {
                    const data = JSON.parse(decodeURIComponent(trackingParam));
                    console.log('üì° Data recibida via URL:', data);
                    showTracking(data);
                    
                    // Limpiar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Error parsing tracking data:', error);
                }
            }
        }

        // üì° WEBHOOK via CORS Proxy + localStorage
        function setupWebhook() {
            // Escuchar mensajes cross-origin
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'TRACKING_DATA') {
                    console.log('üì° Data recibida via webhook:', event.data.payload);
                    showTracking(event.data.payload);
                }
            });

            // Polling localStorage para data de webhook
            setInterval(() => {
                const webhookData = localStorage.getItem('rutia_tracking_data');
                if (webhookData) {
                    try {
                        const data = JSON.parse(webhookData);
                        console.log('üì° Data encontrada en localStorage:', data);
                        showTracking(data);
                        localStorage.removeItem('rutia_tracking_data'); // Limpiar
                    } catch (error) {
                        console.error('Error parsing webhook data:', error);
                    }
                }
            }, 2000);
        }

        // üöÄ INICIALIZAR
        function init() {
            // Webhook URL para n8n
            const webhookUrl = 'https://webhook.site/#!/unique-id'; // Reemplazar con URL real
            document.getElementById('webhookUrl').innerHTML = `
                <code>${webhookUrl}</code><br>
                <small>Configurar en n8n como POST request</small>
            `;
            
            // Setup webhook listener
            setupWebhook();
            
            // Verificar data en URL (fallback)
            checkForTrackingData();
            
            console.log('üó∫Ô∏è La Geogr√°fica Live Tracking iniciado');
        }

        // üé¨ INICIAR
        init();
    </script>
</body>
</html>