<!DOCTYPE html>
<html>
<head>
    <title>üó∫Ô∏è La Geogr√°fica - Tracking Live</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background: #f0f0f0;
        }
        #map { 
            height: 100vh; 
            width: 100%; 
        }
        .status-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
            border: 3px solid #28a745;
        }
        .logo {
            text-align: center;
            margin-bottom: 15px;
        }
        .logo img {
            max-width: 120px;
            height: auto;
        }
        .status-text {
            font-size: 14px;
            color: #333;
            margin: 8px 0;
        }
        .client-name {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
        }
        .rider-status {
            color: #007bff;
            font-weight: bold;
        }
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .eta {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
        .webhook-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            font-size: 11px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="status-panel" id="statusPanel">
        <div class="logo">
            <img src="assets/logo-geografica.png" alt="La Geogr√°fica" />
        </div>
        
        <div id="clientInfo" class="no-data">
            Esperando pedidos...
        </div>
        
        <div class="webhook-info">
            üì° <strong>Webhook URL:</strong><br>
            <span id="webhookUrl">Calculando...</span>
        </div>
    </div>

    <script>
        // üó∫Ô∏è MAPA limpio centrado en CABA
        const map = L.map('map').setView([-34.6037, -58.3816], 12);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'üõµ La Geogr√°fica - Tracking Live',
            maxZoom: 19
        }).addTo(map);

        // üéØ VARIABLES GLOBALES
        let currentRoute = null;
        let currentMarkers = [];
        let riderMarker = null;
        let animationInterval = null;
        let autoCleanTimer = null;

        // üßπ LIMPIAR MAPA
        function clearMap() {
            if (currentRoute) map.removeLayer(currentRoute);
            currentMarkers.forEach(marker => map.removeLayer(marker));
            if (riderMarker) map.removeLayer(riderMarker);
            if (animationInterval) clearInterval(animationInterval);
            
            currentRoute = null;
            currentMarkers = [];
            riderMarker = null;
            
            document.getElementById('clientInfo').innerHTML = '<div class="no-data">Esperando pedidos...</div>';
        }

        // üîß DEDUPLICAR COORDENADAS
        function dedupeCoords(coords) {
            const seen = new Set();
            return coords.filter(coord => {
                const key = `${coord[0]},${coord[1]}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        // üß≠ NEAREST NEIGHBOR
        function nearestNeighborPath(coords) {
            if (coords.length <= 1) return coords;
            
            const unvisited = new Set(Array.from({length: coords.length}, (_, i) => i));
            const path = [0];
            unvisited.delete(0);
            
            while (unvisited.size > 0) {
                const lastIdx = path[path.length - 1];
                const lastCoord = coords[lastIdx];
                
                let nearestIdx = -1;
                let minDist = Infinity;
                
                for (const idx of unvisited) {
                    const coord = coords[idx];
                    const dist = Math.sqrt(
                        Math.pow(coord[0] - lastCoord[0], 2) + 
                        Math.pow(coord[1] - lastCoord[1], 2)
                    );
                    if (dist < minDist) {
                        minDist = dist;
                        nearestIdx = idx;
                    }
                }
                
                path.push(nearestIdx);
                unvisited.delete(nearestIdx);
            }
            
            return path.map(idx => coords[idx]);
        }

        // üó∫Ô∏è MOSTRAR TRACKING
        function showTracking(data) {
            clearMap();
            
            const trackingData = data[0] || data;
            const ruta = trackingData.ruta_calculada?.ruta;
            const cliente = trackingData.ruta_calculada?.cliente;
            const tienda = trackingData.ruta_calculada?.tienda;
            const rider = trackingData.rider;
            
            if (!ruta || !cliente || !tienda) {
                console.error('Datos incompletos');
                return;
            }

            // üìç PROCESAR COORDENADAS
            let coords = ruta.coordenadas_array || [];
            coords = coords.map(c => [c[1], c[0]]); // lon,lat ‚Üí lat,lon
            coords = dedupeCoords(coords);
            coords = nearestNeighborPath(coords);

            // üó∫Ô∏è RUTA
            currentRoute = L.polyline(coords, {
                color: '#007bff',
                weight: 4,
                opacity: 0.6
            }).addTo(map);

            // üè™ TIENDA
            const tiendaMarker = L.marker([tienda.lat, tienda.lon], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="30" height="30" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="15" cy="15" r="12" fill="#28a745" stroke="white" stroke-width="3"/>
                            <text x="15" y="20" text-anchor="middle" font-size="14" fill="white">üè™</text>
                        </svg>
                    `),
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).bindPopup(`üè™ ${tienda.nombre}<br>${tienda.direccion}`).addTo(map);

            // üë§ CLIENTE
            const clienteMarker = L.marker([cliente.lat, cliente.lon], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="30" height="30" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="15" cy="15" r="12" fill="#dc3545" stroke="white" stroke-width="3"/>
                            <text x="15" y="20" text-anchor="middle" font-size="14" fill="white">üë§</text>
                        </svg>
                    `),
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).bindPopup(`üë§ ${cliente.nombre}<br>${cliente.direccion}`).addTo(map);

            // üõµ RIDER ANIMADO
            let currentStep = 0;
            riderMarker = L.marker(coords[0], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12.5" cy="12.5" r="10" fill="#007bff" stroke="white" stroke-width="2"/>
                            <text x="12.5" y="17" text-anchor="middle" font-size="12" fill="white">üõµ</text>
                        </svg>
                    `),
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                })
            }).bindPopup(`üõµ ${rider?.nombre || 'Rider'}`).addTo(map);

            currentMarkers = [tiendaMarker, clienteMarker];

            // üé¨ ANIMACI√ìN RIDER
            animationInterval = setInterval(() => {
                currentStep = (currentStep + 1) % coords.length;
                riderMarker.setLatLng(coords[currentStep]);
            }, 2000);

            // üì± ACTUALIZAR PANEL
            const eta = trackingData.eta_minutos || Math.round(ruta.tiempo_calculado_minutos);
            document.getElementById('clientInfo').innerHTML = `
                <div class="client-name">Hola ${cliente.nombre}!</div>
                <div class="status-text">üìç Recibimos tu pedido</div>
                <div class="status-text">üîÑ Estamos preparando tu pedido</div>
                <div class="status-text">üõµ El rider lleg√≥ a la tienda</div>
                <div class="rider-status">${rider?.nombre || 'Carlos'} est√° en camino</div>
                <div class="eta">‚è±Ô∏è Llegada: ${eta} minutos</div>
            `;

            // üéØ ZOOM
            const group = L.featureGroup([tiendaMarker, clienteMarker, currentRoute]);
            map.fitBounds(group.getBounds().pad(0.1));

            // ‚è∞ AUTO-LIMPIAR
            if (autoCleanTimer) clearTimeout(autoCleanTimer);
            autoCleanTimer = setTimeout(() => {
                clearMap();
                map.setView([-34.6037, -58.3816], 12);
            }, 10 * 60 * 1000);
        }

        // üì° WEBHOOK SIMPLE via URL params
        function checkForTrackingData() {
            const urlParams = new URLSearchParams(window.location.search);
            const trackingParam = urlParams.get('tracking');
            
            if (trackingParam) {
                try {
                    const data = JSON.parse(decodeURIComponent(trackingParam));
                    console.log('üì° Data recibida via URL:', data);
                    showTracking(data);
                    
                    // Limpiar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Error parsing tracking data:', error);
                }
            }
        }

        // üöÄ INICIALIZAR
        function init() {
            // Mostrar webhook URL
            const currentUrl = window.location.href.split('?')[0];
            document.getElementById('webhookUrl').textContent = currentUrl + '?tracking={{JSON_DATA}}';
            
            // Verificar data en URL
            checkForTrackingData();
            
            console.log('üó∫Ô∏è La Geogr√°fica Live Tracking iniciado');
            console.log('üì° n8n puede enviar data via: ' + currentUrl + '?tracking={{JSON_DATA}}');
        }

        // üé¨ INICIAR
        init();
    </script>
</body>
</html>